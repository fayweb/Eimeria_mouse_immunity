---
title: "5. Imputation of missing values"
author: "Fay"
date: '2022-10-05'
output:
  pdf_document: 
    fig_width: 12
    fig_height: 8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries

```{r}
library(mice)
library(tidyr)
library(tidyverse)
library(VIM)
library(fitdistrplus)
```

# Import data

```{r}
hm <- read.csv("output_data/MICE.csv")
```

```{r}
# Vectors for selecting genes

#Lab genes
# The measurements of IL.12 and IRG6 are done with an other assay and will 
#ignore for now
Gene_lab   <- c("IFNy", "CXCR3", "IL.6", "IL.13", "IL.10",
                "IL1RN","CASP1", "CXCL9", "IDO1", "IRGM1", "MPO", 
                "MUC2", "MUC5AC", "MYD88", "NCR1", "PRF1", "RETNLB", "SOCS1", 
                "TICAM1", "TNF") #"IL.12", "IRG6")

Genes_wild   <- c("IFNy", "CXCR3", "IL.6", "IL.13", "IL.10", 
                  "IL1RN","CASP1", "CXCL9", "IDO1", "IRGM1", "MPO", 
                  "MUC2", "MUC5AC", "MYD88", "NCR1", "PRF1", "RETNLB", "SOCS1", 
                  "TICAM1", "TNF") #, "IL.12", "IRG6")

Facs_lab <- c("Position", "CD4", "Treg", "Div_Treg", "Treg17", "Th1", 
                    "Div_Th1", "Th17", "Div_Th17", "CD8", "Act_CD8", 
                    "Div_Act_CD8", "IFNy_CD4", "IFNy_CD8","Treg_prop", 
                    "IL17A_CD4")  

Facs_wild <- c( "Treg", "CD4", "Treg17", "Th1", "Th17", "CD8",
                     "Act_CD8", "IFNy_CD4", "IL17A_CD4", "IFNy_CD8")

```

# How do the variables look like? 
1. cleaning 
```{r}

#how many nas in each column
#sapply(hm, function(x) sum(is.na(x)))

# Required step for the further imputations 
hm  <- hm %>% mutate_if(is.character, as.factor)
hm <- hm %>% mutate_if(is.integer, as.numeric)

```


## Test different distributions

```{r}
facs_variable <- hm %>% 
  filter(origin == "Lab", dpi == max_dpi, infection == "challenge") %>% 
  dplyr::select(CD4) 

facs_variable <- facs_variable %>% drop_na()

x <- facs_variable$CD4

# gene_variable 
y <- hm %>%
  filter(origin == "Lab", dpi == max_dpi, infection == "challenge") %>% 
  dplyr::select(MYD88)

y <- y %>% 
  drop_na()

```

# Fucntions to test distributions

```{r}

# Define function to be used to test, get the log lik and aic
tryDistrib <- function(x, distrib){
  # deals with fitdistr error:
  fit <- tryCatch(MASS::fitdistr(x, distrib), error=function(err) "fit failed")
  return(list(fit = fit,
              loglik = tryCatch(fit$loglik, error=function(err) "no loglik computed"), 
              AIC = tryCatch(fit$aic, error=function(err) "no aic computed")))
}



findGoodDist <- function(x, distribs, distribs2){
  l =lapply(distribs, function(i) tryDistrib(x, i))
  names(l) <- distribs
  print(l)
  listDistr <- lapply(distribs2, function(i){
    if (i %in% "t"){
      fitdistrplus::fitdist(x, i, start = list(df =2))
    } else {
      fitdistrplus::fitdist(x,i)
    }}
  ) 
  par(mfrow=c(2,2))
  denscomp(listDistr, legendtext=distribs2)
  cdfcomp(listDistr, legendtext=distribs2)
  qqcomp(listDistr, legendtext=distribs2)
  ppcomp(listDistr, legendtext=distribs2)
  par(mfrow=c(1,1))
}

```

# For the facs data
```{r}

ggplot(x, aes(CD4)) +
  geom_histogram()

glimpse(x)

set.seed(333)
descdist(data = x, discrete = FALSE)

```

The facs data don't fit a beta distribution.

```{r}
normal_ <- fitdist(x, "norm")
weibull_ <- fitdist(x, "weibull")
gamma_ <- fitdist(x, "gamma")
lognormal_ <- fitdist(x, "lnorm")
exponential_ <- fitdist(x, "exp")
```

```{r}
plot(normal_)
print(normal_)
```
```{r}
plot(weibull_)
print(weibull_)
```


```{r}
plot(gamma_)
print(gamma_)
```


```{r}
plot(lognormal_)
print(lognormal_)
```


```{r}
plot(exponential_)
print(exponential_)
```



```{r}
fitdist(x, "beta") # doesn't work
#fitdist(x, "pois") # ain't working as well

set.seed(24)
descdist(data = x, discrete = FALSE, boot = 100)

library(fitur)
fitur::fit_dist_addin()
```



```{r}



tryDistrib(x, "normal")
tryDistrib(x, "binomial")
tryDistrib(x, "student")
tryDistrib(x, "weibull")
tryDistrib(x, "weibullshifted")
tryDistrib(x, "weibullshifted")
tryDistrib(x, "gamma")
```


# For the gene data
```{r}
tryDistrib(y, "normal")
tryDistrib(y, "binomial")
tryDistrib(y, "student")
tryDistrib(y, "weibull")
tryDistrib(y, "weibullshifted")

```
## Imputing missing data 
I will be using the package MICE (multivariate Imputation by chained 
Equations) which only requires a data frame of missing observations.

Description: *Multiple imputation using Fully Conditional Specification (FCS)*

implemented by the MICE algorithm as described in Van Buuren and
Groothuis-Oudshoorn (2011) <doi:10.18637/jss.v045.i03>. Each variable has
its own imputation model. Built-in imputation models are provided for
continuous data (predictive mean matching, normal), binary data (logistic
regression), unordered categorical data (polytomous logistic regression)
and ordered categorical data (proportional odds). MICE can also impute
continuous two-level data (normal model, pan, second-level variables).
Passive imputation can be used to maintain consistency between variables.
Various diagnostic plots are available to inspect the quality of the
imputations.

https://www.jstatsoft.org/article/view/v045i03

tutorial: https://www.youtube.com/watch?v=WPiYOS3qK70

https://datascienceplus.com/imputing-missing-data-with-r-mice-package/


https://datascienceplus.com/handling-missing-data-with-mice-package-a-simple-approach/



### Missing data can be classified into three categories:
#### 1. Missing completely at random (MCAR)
  
We can't probably predict that value from any other value in the data. 
MCAR implies the reason for the missingness of a field is completely random, 
and that we probably can't predict that value from any other value in the data. 
  
#### 2. Missing at Random (MAR)

Missingess can be explained by other values in other columns, but not from
that column.
  
#### 3. Missing NOT at random (MNAR)


The basic MICE assumption is that the data is missing at random, and that we can 
make a guess about its true value by looking at other data samples.


## Step1 : cleaning and checking the missing data points in our field data. 


```{r impute_missing}

hm %>%
  aggr(col = c('navyblue', 'red'), numbers = TRUE, sortVars = TRUE, 
       labels=names(hm), cex.axis=.7, gap=3, 
       ylab=c("Histogram of missing data","Pattern"))
       
       
marginplot(hm[c(1,2)])

```


## Now let's coninue by ussing the package MICE to impute the data

```{r imputing_mice}

# The frequency distribution of the missing cases per variable can be obtained 
# as:
init <- mice(hm, maxit = 0)

# table of amount of variables with the amount of missing values 
table(init$nmis)

# which method is used for imputation? In this case the package mice 
# uses the default method for continuous variable, 
# which is pmm, or predictive mean matching

meth <- init$method


# now impute the immune gene expression for the field and save it as the oject: 
# igf
# m=5 refers to the number of imputed datasets. Five is the default value.
igf <- mice(hm, method = meth, m = 5, seed = 500)
summary(igf)

# to check each column with imputed data
## igf$imp$IFNy

#Now we can get back the completed dataset using the complete()
completeField <- complete(igf, 1)

```