---
title: "4.Mice_imputation_field.rmd"
author: "Fay"
date: '2022-11-01'
output:
  pdf_document: 
    fig_width: 12
    fig_height: 8

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#################### field

# Field data imputation



```{r imputing_mice}

# field samples
field <- hm %>%
  filter(origin == "Field")

gf_field <- field %>% 
  dplyr::select(all_of(c(Facs_lab, Facs_wild, Gene_lab, Genes_wild)))

#remove rows with only nas
gf_field <- gf_field[,colSums(is.na(gf_field))<nrow(gf_field)]

#remove colums with only nas 
gf_field <- gf_field[rowSums(is.na(gf_field)) != ncol(gf_field), ]


#select same rows in the first table
field <- field[row.names(gf_field), ]



#remove wrongly normalized genes
field <- field %>%
  dplyr::select(-ends_with("_N"))

# really removing empty columns
field <- field %>% 
  discard(~all(is.na(.) | . ==""))


# make a second data frame to keep this data frame at this point
f1 <- field 


# looking at patterns of nas
pattern_na <-as.data.frame(md.pattern(field))

#sapply(field, function(x) sum(is.na(x)))

#select the relevant columns to use for the imputation
field <- field %>%
  dplyr::select(c(Mouse_ID, MC.Eimeria, delta_ct_cewe_MminusE, Sex, Longitude, Latitude, 
                  Year, mtBamH, YNPAR, X332, X347, X65, Tsx, Btk, Syap1, Es1, 
                  Gpd1, Idh1, Mpi, Np, Sod1, Es1C, Gpd1C, Idh1C, NpC, Sod1C,
                  HI_NLoci,  Spleen, Trichuris_muris, Mastophorus_muris, 
                  Catenotaenia_pusilla, Status, 
                  Heterakis_sp, N_oocysts_sq1, 
                  N_oocysts_sq2, N_oocysts_sq3, N_oocysts_sq4, N_oocysts_sq5, 
                  N_oocysts_sq6, N_oocysts_sq7, N_oocysts_sq8, Region, 
                  Body_Length, Fleas, Tail_Length, eimeriaSpecies, Ct.Eimeria,
                  Ct.Mus, ILWE_Crypto_Ct, Aspiculuris_sp, Syphacia_sp, Taenia_sp,
                  Hymenolepis_sp, FEC_Eim_Ct, 
                  all_of(c(Facs_wild, Genes_wild))))
#had to remove as they were disturbing the imputation: Worms_presence, MC.Eimeria.FEC,  Heligmosomoides_polygurus, Zfy2, Y,  MpiC,

#vis_miss(field)


# The frequency distribution of the missing cases per variable can be obtained 
# as:
init <- mice(field, maxit = 0)


#we want to impute only the specific variables
meth <- init$method

#select all the colnames ending in std (the standardized ones)
#std <- colnames(field %>% dplyr::select(ends_with("_std"))) 

# set every variable that is not one of your variables of interest to ""
#You can supply a vector to the method argument of mice::mice. This vector should contain the methods that you want to use to impute the variables you want to impute. In the example they first do a dry-run 
#meth[!(names(meth) %in% all_of(std))] <- ""

# repeat the imputation only for the specific variables
#init <- mice(field, maxit = 0, method = meth)

# table of amount of variables with the amount of missing values 
#table(init$nmis)

# which method is used for imputation? In this case the package mice 
# uses the default method for continuous variable, 
# which is pmm, or predictive mean matching

# now impute the data and save it as the oject: 
# igf

vis_miss(field)

#sapply(field, function(x) sum(is.na(x)))

# will have to remove treg_prop and ooc, as they cause problems with the further
# imputation
#field <- field %>% 
#  dplyr::select(-c(OOC, IFNy_MES, Treg_prop))

# which column numbers end in Std 
#grep("_std", colnames(field) )

#imp <- mice(field, print = FALSE)


```


```{r}
# m=5 refers to the number of imputed datasets. Five is the default value.
igf <- mice(field[, -1], m = 5, seed = 500) # method = meth,
summary(igf)

# to check each column with imputed data
## igf$imp$IFNy

#Now we can get back the completed dataset using the complete()
complete_field <- complete(igf, 1)

#visualize missingness
vis_miss(complete_field)

#sapply(complete_field, function(x) sum(is.na(x)))


# select the required columns
imp_field <- complete_field %>%
  dplyr::select(all_of(c(Facs_wild, Genes_wild)))


#add an ending to the imputed columns
colnames(imp_field) <- paste(colnames(imp_field), "imp", sep = "_")

#now join it to the full data set of the laboratory infections
field <- cbind(f1, imp_field)

```


Let’s compare the distributions of original and imputed data using a some useful 
plots.First of all we can use a scatterplot and plot Ozone against all the other 
variables. Let's first plot the variables for which we have few missing values.



```{r distr_orig_pred}

xyplot(igf, IFNy ~ IL.13 + IRGM1 + MUC2, pch=18,cex=1)


```


What we would like to see is that the shape of the magenta points (imputed) 
matches the shape of the blue ones (observed). The matching shape tells us that 
the imputed values are indeed “plausible values”.

Now let's plot the variables with many missing data points.


```{r distr_orig_pred2}

xyplot(igf,IFNy ~ IL.10 + PRF1 + CASP1, pch=18,cex=1)
```



```{r }
stripplot(igf, pch = 20, cex = 1.2)
```



```{r densityplotfield}
#densityplot(igf)
```

The density of the imputed data for each imputed dataset is showed in magenta 
while the density of the observed data is showed in blue. Again, under our 
previous assumptions we expect the distributions to be similar.

Another useful visual take on the distributions can be obtained using the 
stripplot() function that shows the distributions of the variables as individual 
points





# Joining the two data frames for further analysis
```{r}


# ow join the two data sets
imputed_hm <- full_join(f1, lab, 
                  by = intersect(colnames(f1), colnames(lab)))

imputed_hm <- unique(imputed_hm)

##save the imputed data 
write.csv(imputed_hm, "output_data/imputed_MICE.csv", row.names = FALSE)


```

