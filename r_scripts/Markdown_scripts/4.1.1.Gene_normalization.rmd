---
title: "4.1.1.Gene_normalization"
author: "Fay"
date: '2023-02-20'
output:
  pdf_document:
    keep_md: yes 
    fig_width: 12
    fig_height: 8
  html_document:
    df_print: paged
---
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Aim: 

Normalize gene expression

I have tried the delta delta ct to get the fold gene expression and the 
delta ct method. 

As we are having data from wild infections with unknown status we can't do the 
delta delta ct method. For that we would have needed control samples - for example
uninfected vs infected. I tried to correct for that by getting the mean of every 
sample for each target gene and using it as a control but that didn't work. 
The values became non-comparable and then my data became very bad at predicting. 
By using the delta ct method, I increased the accuracy of my predictions. 

Since the data sets are "mixed", wild and laboratory data, plus differnt runs, 
the delta ct should be enough to get the difference between the housekeeping gene
and each sample (representing each run of the sample).

Another problem is that we have measurements for the house keeping genes 
PPIB and GAPDH. For the field samples, more than 50 % of PPIB is missing, whereas
for the laboratory samples 80 % of GAPDH is missing. 

I would have liked to use the geometric mean of two housekeeping genes. 
In this case I am limited to use one for each data set. 


https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3489534/#:~:text=We%20suggest%20that%20normalization%20be,imputation%2C%20significance%20analysis%20and%20visualization.
In publication:
We suggest that normalization be done first followed by missing value imputations. 
Software tools such as DanteR as well as stand-alone functions in R and 
Matlab may be used to perform normalization, imputation, significance analysis
and visualization.

# Load libraries



```{r}
library(mice)
library(tidyr)
library(tidyverse)
library(VIM)
library(fitdistrplus)
library(fitur)
library(visdat)
library(DESeq2)
library(limma)
```

# Load data

# Import data

```{r}
hm <- read.csv("output_data/1.MICE_cleaned_data.csv")
```

I only include GAPDH as a housekeeping gene, as PPIB is missing in a large number

```{r}
# Vectors for selecting genes
#Lab genes
# The measurements of IL.12 and IRG6 are done with an other assay and will 
#ignore for now
Gene_lab   <- c("IFNy", "CXCR3", "IL.6", "IL.13", "IL.10",
                "IL1RN","CASP1", "CXCL9", "IDO1", "IRGM1", "MPO", 
                "MUC2", "MUC5AC", "MYD88", "NCR1", "PRF1", "RETNLB", "SOCS1", 
                "TICAM1", "TNF") #"IL.12", "IRG6")

Genes_wild   <- c("IFNy", "CXCR3", "IL.6", "IL.13", "IL.10", 
                  "IL1RN","CASP1", "CXCL9", "IDO1", "IRGM1", "MPO", 
                  "MUC2", "MUC5AC", "MYD88", "NCR1", "PRF1", "RETNLB", "SOCS1", 
                  "TICAM1", "TNF") #, "IL.12", "IRG6")

Facs_lab <- c("CD4", "Treg", "Div_Treg", "Treg17", "Th1", 
                    "Div_Th1", "Th17", "Div_Th17", "CD8", "Act_CD8", 
                    "Div_Act_CD8", "IFNy_CD4", "IFNy_CD8","Treg_prop", 
                    "IL17A_CD4")  

Facs_wild <- c( "Treg", "CD4", "Treg17", "Th1", "Th17", "CD8",
                     "Act_CD8", "IFNy_CD4", "IL17A_CD4", "IFNy_CD8")
```



# Genes
```{r imputing_mice}
hm$Mouse_ID <- str_replace(hm$Mouse_ID, "_", "")

field <- hm %>%
  dplyr::filter(origin == "Field") 

field <- unique(field)

genes_mouse_field <- field %>%
  dplyr::select(c(Mouse_ID, all_of(Genes_wild), GAPDH)) 

genes_field <- genes_mouse_field  %>%
  dplyr::select(-Mouse_ID)
#remove rows with only nas
genes_field <- genes_field[,colSums(is.na(genes_field))<nrow(genes_field)]
#remove colums with only nas 
genes_field <- genes_field[rowSums(is.na(genes_field)) != ncol(genes_field), ]
genes_mouse_field <- genes_mouse_field[row.names(genes_field), ]

##select same rows in the first table
field <- field[row.names(genes_field), ]


###############lab
#select the genes and lab muce
lab <- hm %>%
  dplyr::filter(origin == "Lab", Position == "mLN") #selecting for mln to avoid
# duplicates
lab <- unique(lab)
gene_lab_mouse <- lab %>%
  dplyr::select(c(Mouse_ID, "IFNy", "CXCR3", "IL.6", "IL.13", "IL.10",                 "IL1RN","CASP1", "CXCL9", "IDO1", "IRGM1", "MPO",                  "MUC2", "MUC5AC", "MYD88", "NCR1", "PRF1", "RETNLB", "SOCS1",                  "TICAM1", "TNF", PPIB)) 

gene_lab_mouse <- unique(gene_lab_mouse)

genes_lab <- gene_lab_mouse[, -1]

#remove rows with only nas
genes_lab <- genes_lab[,colSums(is.na(genes_lab))<nrow(genes_lab)]

#remove colums with only nas 
genes_lab <- genes_lab[rowSums(is.na(genes_lab)) != ncol(genes_lab), ]

genes_lab <- unique(genes_lab)

#select same rows in the first table
gene_lab_mouse <- gene_lab_mouse[row.names(genes_lab), ]

##select same rows in the first table
lab <- lab[row.names(genes_lab), ]

#join the genes
genes_total <- rbind(genes_mouse_field[,-22], gene_lab_mouse[,-22])

# make the row names to correspond mouse ID
row.names(genes_total) <- genes_total$Mouse_ID

genes_total <- genes_total %>%
  dplyr::select(-Mouse_ID)
```

Quantile normalization

```{r}
genes_total_matrix <- as.matrix(genes_total)


genes_total_matrix <- limma::normalizeQuantiles(genes_total_matrix)

quantile(genes_lab$TNF, na.rm = TRUE)
quantile(genes_field$TNF, na.rm = TRUE)

quantile(genes_lab$IRGM1, na.rm = TRUE)
quantile(genes_field$IRGM1, na.rm = TRUE)
```



```{r}
 ##save the imputed data 
write.csv(hm_norm, "output_data/2.1.norm_MICE_data_set.csv", row.names = FALSE)
```
